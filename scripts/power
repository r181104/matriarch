#!/bin/sh

set -euo pipefail

echo ">>> Installing TLP..."
sudo pacman -S --noconfirm tlp tlp-rdw

echo ">>> Enabling TLP service..."
sudo systemctl enable --now tlp.service
sudo systemctl mask systemd-rfkill.service systemd-rfkill.socket

echo ">>> Configuring TLP..."
sudo sed -i 's/^#\?START_CHARGE_THRESH_BAT0.*/START_CHARGE_THRESH_BAT0=80/' /etc/tlp.conf
sudo sed -i 's/^#\?STOP_CHARGE_THRESH_BAT0.*/STOP_CHARGE_THRESH_BAT0=95/' /etc/tlp.conf

# Set balanced CPU governor (powersave on battery, schedutil on AC)
sudo sed -i 's/^#\?CPU_SCALING_GOVERNOR_ON_AC.*/CPU_SCALING_GOVERNOR_ON_AC=schedutil/' /etc/tlp.conf
sudo sed -i 's/^#\?CPU_SCALING_GOVERNOR_ON_BAT.*/CPU_SCALING_GOVERNOR_ON_BAT=powersave/' /etc/tlp.conf

echo ">>> Restarting TLP..."
sudo systemctl restart tlp.service

echo ">>> Verifying TLP setup..."
tlp-stat -s || true
tlp-stat -b || true
tlp-stat -p || true

echo ">>> Done! TLP is running in balanced mode with charging thresholds set (80â€“95%)."
