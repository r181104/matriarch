#!/bin/sh

# Arch Linux + Hyprland + Fish automatic GNOME Keyring setup

set -e

echo "🔑 Checking GNOME Keyring setup..."

# --- Step 1: Install required packages ---
needed_pkgs=(gnome-keyring seahorse libsecret)
missing_pkgs=()

for pkg in "${needed_pkgs[@]}"; do
    if ! pacman -Qi "$pkg" &>/dev/null; then
        missing_pkgs+=("$pkg")
    fi
done

if [ ${#missing_pkgs[@]} -gt 0 ]; then
    echo "📦 Installing missing packages: ${missing_pkgs[*]}"
    sudo pacman -S --needed --noconfirm "${missing_pkgs[@]}"
else
    echo "✅ Required packages already installed."
fi

# --- Step 2: Enable systemd user service ---
if ! systemctl --user is-enabled gnome-keyring-daemon.service &>/dev/null; then
    echo "🔄 Enabling GNOME Keyring systemd service..."
    systemctl --user enable --now gnome-keyring-daemon.service
else
    echo "✅ GNOME Keyring systemd service already enabled."
fi

# --- Step 3: Ensure Hyprland starts the daemon ---
HYPRCONF="$HOME/.config/hypr/conf/startup.conf"
DAEMON_CMD='exec-once = /usr/bin/gnome-keyring-daemon --start --components=pkcs11,secrets,ssh,gpg'

if ! grep -Fxq "$DAEMON_CMD" "$HYPRCONF" 2>/dev/null; then
    echo "⚙️ Adding GNOME Keyring daemon start to $HYPRCONF"
    echo "$DAEMON_CMD" >>"$HYPRCONF"
else
    echo "✅ Hyprland already configured to start GNOME Keyring."
fi

# --- Step 4: Ensure Fish exports SSH_AUTH_SOCK correctly ---
FISHCONF="$HOME/.config/fish/config.fish"
FISH_LINE='set -Ux SSH_AUTH_SOCK (gpgconf --list-dirs agent-ssh-socket)'

if ! grep -Fxq "$FISH_LINE" "$FISHCONF" 2>/dev/null; then
    echo "⚙️ Adding SSH_AUTH_SOCK export to $FISHCONF"
    echo "$FISH_LINE" >>"$FISHCONF"
else
    echo "✅ Fish already configured for SSH_AUTH_SOCK."
fi

# --- Step 5: Ensure PAM integration ---
# We'll patch /etc/pam.d/login (TTY/LightDM/SDDM) and gdm-password (if GDM exists)

add_pam_lines() {
    local pamfile="$1"
    if [ -f "$pamfile" ]; then
        if ! grep -q "pam_gnome_keyring.so" "$pamfile"; then
            echo "⚙️ Adding PAM lines to $pamfile (requires sudo)"
            sudo tee -a "$pamfile" >/dev/null <<'EOF'

# Unlock GNOME Keyring on login
auth     optional  pam_gnome_keyring.so
session  optional  pam_gnome_keyring.so auto_start
EOF
        else
            echo "✅ PAM already configured in $pamfile"
        fi
    fi
}

add_pam_lines "/etc/pam.d/login"
add_pam_lines "/etc/pam.d/gdm-password"

echo "🎉 Setup complete! Log out and back in (or reboot) for changes to take effect."
