#!/bin/sh

set -euo pipefail

# NOTE: Re-run with sudo if not root
if [ "$(id -u)" -ne 0 ]; then
    echo "This script requires sudo privileges. Re-running with sudo..."
    exec sudo bash "$(readlink -f "$0")" "$@"
fi

echo "=== Chaotic-AUR setup script ==="

# NOTE: Key details
KEY_ID="3056513887B78AEB"
KEYSERVER="keyserver.ubuntu.com"

# NOTE: Step 1: Import and sign key if not already
if ! pacman-key --list-keys "$KEY_ID" &>/dev/null; then
    echo "-> Importing Chaotic-AUR key..."
    pacman-key --recv-key "$KEY_ID" --keyserver "$KEYSERVER"
    pacman-key --lsign-key "$KEY_ID"
else
    echo "-> Key already present."
fi

# NOTE: Step 2: Install chaotic-keyring if not already
if ! pacman -Q chaotic-keyring &>/dev/null; then
    echo "-> Installing chaotic-keyring..."
    pacman -U --noconfirm \
        'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'
else
    echo "-> chaotic-keyring already installed."
fi

# NOTE: Step 3: Install chaotic-mirrorlist if not already
if ! pacman -Q chaotic-mirrorlist &>/dev/null; then
    echo "-> Installing chaotic-mirrorlist..."
    pacman -U --noconfirm \
        'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'
else
    echo "-> chaotic-mirrorlist already installed."
fi

# NOTE: Step 4: Configure pacman.conf if missing
if ! grep -q "^\[chaotic-aur\]" /etc/pacman.conf; then
    echo "-> Adding Chaotic-AUR repo to /etc/pacman.conf"
    cat <<'EOF' >>/etc/pacman.conf

[chaotic-aur]
Include = /etc/pacman.d/chaotic-mirrorlist
EOF
else
    echo "-> Chaotic-AUR repo already in pacman.conf."
fi

# NOTE: Step 5: Sync packages
echo "-> Running pacman -Syu"
pacman -Syu --noconfirm

echo "=== Chaotic-AUR installation complete ==="
